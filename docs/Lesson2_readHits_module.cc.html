<!DOCTYPE html> <html> <head>   <title>Lesson2/readHits_module.cc</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link href="css/prettify.css" type="text/css" rel="stylesheet" />   <link rel="stylesheet" media="all" href="css/docco.css" />   <script type="text/javascript" src="js/prettify.js"></script> </head> <body onload="prettyPrint()">   <div id="container">     <div id="background"></div>     <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h2>               <a href="../Lesson2/readHits_module.cc">Lesson2/readHits_module.cc</a>             </h2>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <pre class="prettyprint">////////////////////////////////////////////////////////////////////////
</pre>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Class:       readHits Module Type: analyzer File:        readHits_module.cc </p>

             </td>             <td class="code">               <pre class="prettyprint">//
</pre>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Generated at Tue Oct 18 16:46:20 2011 by Adam Lyon using artmod from art v0_07_13. </p>

             </td>             <td class="code">               <pre class="prettyprint">//
</pre>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>We&#8217;ll read in the hit information and make some histograms and  a simple root-tuple. This module will make use of the &#8220;TFileService&#8221; to  show how to manipulate and create things in a Root file. We&#8217;ll put the histograms and ntuple in different directories of the root file. </p>

             </td>             <td class="code">               <pre class="prettyprint">////////////////////////////////////////////////////////////////////////

#include "art/Framework/Core/EDAnalyzer.h"
#include "art/Framework/Core/ModuleMacros.h"

#include "TH1F.h"
#include "TTree.h"
#include "art/Framework/Services/Optional/TFileService.h"
#include "art/Framework/Services/Registry/ServiceHandle.h"

#include "HitAndTrackObjects/HitCollection.hh"


namespace artex {
  class readHits;
}

class artex::readHits : public art::EDAnalyzer {
public:
  explicit readHits(fhicl::ParameterSet const &p);
  virtual ~readHits();

  virtual void analyze(art::Event const &e);


private:

</pre>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Declare member data here. </p>

             </td>             <td class="code">               <pre class="prettyprint">    
</pre>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Names of the sub-directories in the root file </p>

             </td>             <td class="code">               <pre class="prettyprint">    std::string hist_dir_, tree_dir_;
    
</pre>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The histograms </p>

             </td>             <td class="code">               <pre class="prettyprint">    TH1F * h_weights_, * h_z_, * h_r_, * h_phi_; 
    
</pre>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The root-tuple </p>

             </td>             <td class="code">               <pre class="prettyprint">    TTree * t_hitTree_;
    
</pre>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Variables for the tree </p>

             </td>             <td class="code">               <pre class="prettyprint">    int tf_event_;
    float tf_r_, tf_phi_, tf_z_, tf_w_;
};


artex::readHits::readHits(fhicl::ParameterSet const &p) :
    hist_dir_( p.get&lt;std::string&gt;("hist_dir") ),
    tree_dir_( p.get&lt;std::string&gt;("tree_dir") )
{
</pre>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>You could require that hist_dir and tree_dir have some real strings, but what if the user just leaves them blank. We then want to use the top level directory. Note that the TFileService handle dereferences to an object that inherits from  TFileDirectory. This will be a little tricky, so pay close attention </p>

             </td>             <td class="code">               <pre class="prettyprint">    
</pre>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Get the service handle &#8211; dereferencing this will be an object that inherits from TFileDirectory &#8211; so it can do the same things as TFileDirectory </p>

             </td>             <td class="code">               <pre class="prettyprint">    art::ServiceHandle&lt;art::TFileService&gt; tfs;
    
</pre>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Do the histograms first.  Let&#8217;s assume the top directory. This is *tfs itself </p>

             </td>             <td class="code">               <pre class="prettyprint">    art::TFileDirectory histDir = *tfs;
    
</pre>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Did we specify a directory, if so, reassign histDir to the new directory </p>

             </td>             <td class="code">               <pre class="prettyprint">    if ( ! hist_dir_.empty() ) {
        histDir = tfs-&gt;mkdir( hist_dir_ );  // Note how we re-assigned histDir
    }
    
</pre>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create the histogram objects </p>

             </td>             <td class="code">               <pre class="prettyprint">    h_weights_ = histDir.make&lt;TH1F&gt;("hitWeights", "Hit Weights", 25,    0.0,   1.0);
    h_z_       = histDir.make&lt;TH1F&gt;("hitZ",       "z of hits",   50, -100.0, 100.0);
    h_r_       = histDir.make&lt;TH1F&gt;("hitR",       "r of hits",   50,    0.0, 100.0);
    h_phi_     = histDir.make&lt;TH1F&gt;("hitPhi",     "phi of hits", 50,    0.0,   6.3);
    
</pre>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Do the tree next </p>

             </td>             <td class="code">               <pre class="prettyprint">    art::TFileDirectory treeDir = *tfs;
    if ( ! tree_dir_.empty() ) {
        treeDir = tfs-&gt;mkdir( tree_dir_ );
    }
    
    t_hitTree_ = treeDir.make&lt;TTree&gt;("hitTree", "Tree of hits");
    t_hitTree_-&gt;Branch("event", &tf_event_, "event/I");
    t_hitTree_-&gt;Branch("r", &tf_r_, "r/F");
    t_hitTree_-&gt;Branch("phi", &tf_phi_, "phi/F");
    t_hitTree_-&gt;Branch("z", &tf_z_, "z/F");
    t_hitTree_-&gt;Branch("weights", &tf_w_, "weights/F");
}
    
artex::readHits::~readHits() {
</pre>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Clean up dynamic memory and other resources here. </p>

             </td>             <td class="code">               <pre class="prettyprint">}

void artex::readHits::analyze(art::Event const &e) {
  
</pre>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Extract the hits </p>

             </td>             <td class="code">               <pre class="prettyprint">    art::Handle&lt; HitCollection &gt; hitHandle;
    e.getByLabel("makeHits", hitHandle); // The name here is the producer label
    HitCollection const& hits = *hitHandle;
    
</pre>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Loop over the hits </p>

             </td>             <td class="code">               <pre class="prettyprint">    for ( size_t i=0; i &lt; hits.size(); ++i ) {
        
</pre>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Get the hit </p>

             </td>             <td class="code">               <pre class="prettyprint">        Hit const& hit = hits[i];
        CLHEP::Hep3Vector const& position = hit.position();
        double weight = hit.weight();
        
</pre>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Fill the plots </p>

             </td>             <td class="code">               <pre class="prettyprint">        h_weights_ -&gt; Fill(weight                );
        h_r_       -&gt; Fill(position.r(),   weight);
        h_phi_     -&gt; Fill(position.phi(), weight);
        h_z_       -&gt; Fill(position.z(),   weight);
        
</pre>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Fill the tree </p>

             </td>             <td class="code">               <pre class="prettyprint">        tf_event_ = e.id().event();
        tf_r_ = position.r();
        tf_phi_ = position.phi();
        tf_z_ = position.z();
        tf_w_ = weight;
        
        t_hitTree_ -&gt; Fill();
    }
    
}

DEFINE_ART_MODULE(artex::readHits);

</pre>             </td>           </tr>                </tbody>     </table>   </div> </body> </html>